<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Tutorial graphs tables en - MSC Open Data / Données ouvertes du SMC</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../css/extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">MSC Open Data / <br>Données ouvertes du SMC</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Available data /<br>Données disponibles <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../msc-data/readme_en/" class="dropdown-item">Data list /<br>Liste des données</a>
</li>
                                    
<li>
    <a href="../../msc-data-themes/readme_en/" class="dropdown-item">Theme list /<br>Liste de thèmes</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Data access /<br>Accès aux données <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../msc-geomet/readme_en/" class="dropdown-item">MSC GeoMet /<br>GeoMet du SMC</a>
</li>
                                    
<li>
    <a href="../../msc-datamart/readme_en/" class="dropdown-item">MSC Datamart /<br>Datamart du SMC</a>
</li>
                                    
<li>
    <a href="../../cost-recovered/readme_en/" class="dropdown-item">Cost-recovered services /<br>Services à recouvrement de coûts</a>
</li>
                                    
<li>
    <a href="../../msc-animet/readme_en/" class="dropdown-item">MSC AniMet /<br>AniMet du SMC</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Usage and tutorials / <br>Utilisation et tutoriels <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../readme_en/" class="dropdown-item">Usage overview/<br>Aperçu de l'utilisation</a>
</li>
                                    
<li>
    <a href="../tutorials_en/" class="dropdown-item">Access tutorials /<br>Accéder aux tutoriels</a>
</li>
                                    
<li>
    <a href="../../msc-geomet/wms_en/" class="dropdown-item">WMS technical doc /<br>Doc technique du WMS</a>
</li>
                                    
<li>
    <a href="../../msc-geomet/wcs_en/" class="dropdown-item">WCS technical doc /<br>Doc technique du WCS</a>
</li>
                                    
<li>
    <a href="../../msc-geomet/ogc_api_en/" class="dropdown-item">OGC API technical doc /<br>Doc technique de l'OGC API</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="https://weather.gc.ca/mainmenu/contact_us_e.html" class="nav-link">Contact us /<br>Contactez-nous</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search /<br> <i class="fa fa-fw"></i>Rechercher
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#tutorial-create-interactive-web-graphs-and-tables" class="nav-link">Tutorial : Create interactive web graphs and tables</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#send-a-getcapabilities-request-and-fetch-time-parameters" class="nav-link">Send a GetCapabilities request and fetch time parameters</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#prepare-queries" class="nav-link">Prepare queries</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#adjust-hours" class="nav-link">Adjust hours</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#send-prepared-queries" class="nav-link">Send prepared queries</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#interactive-web-graph-creation-with-plotlyjs" class="nav-link">Interactive web graph creation with Plotly.js</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#view-data-in-a-table" class="nav-link">View data in a table</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#add-a-heatmap-to-a-table" class="nav-link">Add a heatmap to a table</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><a href="../tutorial_graphs-tables_fr/">En français</a></p>
<p><img alt="ECCC logo" src="../../img_eccc-logo.png" /></p>
<p><a href="../../readme_en/">TdM</a> &gt; <a href="../readme_en/">Usage overview</a> &gt; Create interactive web graphs and tables</p>
<h1 id="tutorial-create-interactive-web-graphs-and-tables">Tutorial : Create interactive web graphs and tables</h1>
<p>Geospatial web services from <a href="../../msc-geomet/readme_en/">MSC's GeoMet</a> can easily be integrated into open and free web libraries such as <a href="https://plotly.com/javascript/">Plotly.js</a> to create interactive graphics for web pages and mobile applications. This tutorial will show you how to work with the WMS (Web Map Service) standard using Plotly. Upon completion, you will be able to display any WMS layer from GeoMet from SMC on an interactive graph, query the layer for data, and display it in a table.</p>
<ul>
<li><a href="#send-a-getcapabilities-request-and-fetch-time-parameters">Send a GetCapabilities request</a></li>
<li><a href="#prepare-queries">Prepare queries</a></li>
<li><a href="#adjust-hours">Adjust hours</a></li>
<li><a href="#send-prepared-queries">Send queries</a></li>
<li><a href="create-an-interactive-graph-with-plotlyjs">Interactive web graph creation with Plotly.js</a></li>
<li><a href="#view-data-in-table">View data in a table</a></li>
<li><a href="#add-a-heatmap-to-a-table">Add a heatmap to a table</a></li>
</ul>
<h2 id="send-a-getcapabilities-request-and-fetch-time-parameters">Send a GetCapabilities request and fetch time parameters</h2>
<p>The following steps will show you how to create a simple web table with an interactive Plotly.js chart. The graph will display the probabilities that there is more than 0.2mm, 1.0mm, 2.5mm, and 5.0mm of precipitation at a specific location. (<code>REPS.DIAG.6_PRMM.ERGE0.2</code>,<code>REPS.DIAG.6_PRMM.ERGE1</code>, <code>REPS.DIAG.6_PRMM.ERGE2.5</code> and<code>REPS.DIAG.6_PRMM.ERGE5</code>). We will also query the <code>RDPS.ETA_TT</code>,<code>RDPS.ETA_WD</code> and <code>RDPS.ETA_WSPD</code> layers to be able to visualize and display the data concerning the modulus and direction of the winds as well as the temperature.</p>
<h3 id="html">HTML</h3>
<pre><code class="language-html">&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;Graph and table example&lt;/title&gt;
    &lt;meta name=&quot;description&quot; content=&quot;Graph and table example&quot;&gt;
    &lt;link href=&quot;style.css&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css&quot; integrity=&quot;sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO&quot; crossorigin=&quot;anonymous&quot;&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row title&quot;&gt;
            &lt;header class=&quot;masthead mb-auto&quot;&gt;
                &lt;div class=&quot;inner&quot;&gt;
                    &lt;h1 class=&quot;masthead-brand&quot; id=&quot;title&quot;&gt;&lt;/h1&gt;
                &lt;/div&gt;
            &lt;/header&gt;
        &lt;/div&gt;
        &lt;div class=&quot;row graph-and-table&quot;&gt;
            &lt;div class=&quot;reps0 col-sm-12&quot;&gt;
                &lt;div id=&quot;reps0&quot;&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;table-probs col-sm-offset-0 col-sm-12&quot;&gt;
                &lt;table id=&quot;table-probs&quot; class=&quot;probs&quot; media=&quot;print&quot;&gt;
                    &lt;caption id=&quot;table-title&quot;&gt;Forecast for a 6 hours period&lt;/caption&gt;
                    &lt;caption id=&quot;table-footer&quot;&gt;*Please note that these data come from non-expert meteorological models.&lt;/caption&gt;
                    &lt;thead&gt;
                        &lt;tr&gt;
                            &lt;th&gt;Starting&lt;/th&gt;
                            &lt;th&gt;≥0.2 mm&lt;/th&gt;
                            &lt;th&gt;≥1.0 mm&lt;/th&gt;
                            &lt;th&gt;≥2.5 mm&lt;/th&gt;
                            &lt;th&gt;≥5.0 mm&lt;/th&gt;
                            &lt;th&gt;Temp.&lt;/th&gt;
                            &lt;th&gt;Winds&lt;/th&gt;
                        &lt;/tr&gt;
                    &lt;/thead&gt;
                    &lt;tbody&gt;
                    &lt;/tbody&gt;
                &lt;/table&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;col-sm-offset-0 col-sm-3&quot;&gt;
            &lt;div class=&quot;class-sm-offset-1 col-sm-12&quot;&gt;
                &lt;p&gt;&lt;/p&gt;
            &lt;/div&gt;
            &lt;div class=&quot;class-sm-offset-1 col-sm-12&quot;&gt;
                &lt;p&gt;&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdn.plot.ly/plotly-2.0.0.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://code.jquery.com/jquery-3.3.1.slim.min.js&quot; integrity=&quot;sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js&quot; integrity=&quot;sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js&quot; integrity=&quot;sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;main.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;

</code></pre>
<h3 id="css">CSS</h3>
<pre><code class="language-css"> html,
 body {
   height: 100%;
   background-color: rgb(255, 255, 255);
 }
 h1 {
   text-align: center;
 }
 body {
   display: -ms-flexbox;
   display: -webkit-box;
   display: flex;
   -ms-flex-pack: center;
   -webkit-box-pack: center;
   justify-content: center;
   color: #fff;
   text-shadow: 0 .05rem .1rem rgba(0, 0, 0, .5);
   -webkit-print-color-adjust: exact;
 }
 #reps0 {
   display: flex;
 }
 #table-title {
   padding-top: .75rem;
   padding-bottom: .75rem;
   color: #6c757d;
   text-align: center;
   caption-side: top;
 }
 .probs {
   border: 1px solid #C0C0C0;
   border-collapse: collapse;
   padding: 5px;
   margin: auto;
 }
 .probs th {
   border: 1px solid #C0C0C0;
   padding: 5px;
   background: #F0F0F0;
   background: #797979;
   color: white;
   text-align: center;
 }
 .probs td {
   border: 1px solid #C0C0C0;
   text-align: center;
   padding: 5px;
 }
  #nan {
    background-color: #797979;
  }
  h1#title.masthead-brand {
    text-align: center;
  }
  div.row.title {
    margin: auto;
    display: inline;
  }
</code></pre>
<p>In order to use Plotly, we need to import the required JS and CSS libraries. A <code>&lt;div&gt;</code> element is added to the body of our HTML document and assigned an <code>id</code> attribute with a value of <code>reps0</code>. The "id" value will be referenced in the JavaScript code in order to specify where to place the interactive graphic in the HTML document.</p>
<p>Some CSS is also added in order to define the style of the table and the height and width of the chart.</p>
<h3 id="javascript">Javascript</h3>
<p>With the HTML code now complete, let's turn our attention to writing the JavaScript code needed to create our web application.</p>
<pre><code class="language-javascript">const parser = new DOMParser();
const [coordX, coordY] = [45.472, -73.750]; //CYUL airport
const layer02 = 'REPS.DIAG.6_PRMM.ERGE0.2'; //Regional precipitation &gt;= 0.2mm
const layer1 = 'REPS.DIAG.6_PRMM.ERGE1'; //Regional precipitation &gt;= 1mm
const layer25 = 'REPS.DIAG.6_PRMM.ERGE2.5'; //Regional precipitation &gt;= 2.5mm
const layer5 = 'REPS.DIAG.6_PRMM.ERGE5'; //Regional precipitation &gt;= 5mm
const layerTemp = 'RDPS.ETA_TT'; //Temperature
const layerWindDir = 'RDPS.ETA_WD'; //Wind direction
const layerWindSp = 'RDPS.ETA_WSPD'; //Wind speed
const server = 'https://geo.weather.gc.ca/geomet?service=WMS&amp;version='; //SMC's GeoMet server
const getCapab = server + '1.3.0&amp;request=GetCapabilities&amp;layers='; //Link to GetCapabilities
let [version, request, info_format] = ['1.3.0', 'GetFeatureInfo', 'application/json']; //Version, request and format for the information
let [minx, miny, maxx, maxy] = [coordX - 0.25, coordY - 0.25, coordX + 0.25, coordY + 0.25]; //bbox around CYUL airport
</code></pre>
<p>To keep things in order, we initially initialize constants that contain the essential information. We need the coordinates of the requested place (<code>coordX</code>,<code>coordY</code>), the 7 layers that we want to query (<code>layer02</code>,<code>layer1</code>, etc.), the link to the MSC's GeoMet server in order to be able to perform our <code>fetch()</code> requests, the version, the type of request and the format of the response. Once the parameters have been selected, you must calculate the values ​​of the query's <code>bbox</code> parameter (location targeted by the query).</p>
<p>Using the <code>Fetch</code> API, we can do a GetCapabilities on the <code>layer02</code> variable for the <code>REPS.DIAG.6_PRMM.ERGE0.2</code> layer. Once converted to text and read, the <code>result</code> variable contains all the information about that layer.
With the <code>DOMParser</code> of the declared <code>parser</code> constant, we will be able to query the response so that we can retrieve the <code>dimension</code> for the time information.</p>
<p>Once our constants and variables have been declared and initialized, we can now define our first <code>getCapabilities()</code> method, which will be responsible for retrieving our time information.</p>
<pre><code class="language-javascript">async function getCapabilities() {
  let response = await fetch(getCapab + layer02);
  let data = await response.text().then((data) =&gt;
    parser
      .parseFromString(data, &quot;text/xml&quot;)
      .getElementsByTagName(&quot;Dimension&quot;)[0]
      .innerHTML.split(&quot;/&quot;)
  );
  return [data[0], data[1], data[2]];
}
</code></pre>
<p>The asynchronous function is created to retrieve the start time, end time and the time interval currently available for the data in the layer (REPS.DIAG.6_PRMM.ERGE02). When a response is received, the DOMParser() is used to retrieve the content of the GetCapabilities <Dimension> tag and returns an array containing three elements representing the start and end time of the available weather data as well as the interval of the weather data. data.</p>
<p>We can now develop the main algorithm of the application.</p>
<pre><code class="language-javascript">getCapabilities().then(function(response) {
  let startTime = response[0]; //Initialise la date de début
  let endTime = response[1]; //Initialise la date de fin
    let interval = response[2].match(/\d+/)[0]; //RegEx pour avoir le nombre d'heures d'intervalles: Par exemple: PT6H -&gt; 6
    startDate = new Date(startTime); //Objet Date pour la date de début
    endDate = new Date(endTime); //Objet Date pour la date de fin
    var dif = (Math.abs(endDate - startDate) / 36e5) / interval; //Différence entre la date de début et celle de fin selon l'intervalle
    let headers = [];
    headers.push(interval, startDate, dif); //Pousse les informations nécéssaires pour la préparation des requêtes
    headers = prepareRequests(headers, server); //Prépare les requêtes. Headers[0] contient les dates et le reste du tableau, les URLs
    let begin = startTime.split('T')[0]; //Titre de la page
    document.getElementById(&quot;title&quot;).innerHTML = &quot;CYUL forecast for &quot; + begin; //Titre du DOM
    let adjustedUTC = adjustUTC(headers[0]); //Ajuste les heures en fonctions du fuseau horaire de l'utilisateur
    let promises = []; //Tableau pour les Promises
    /*
     * La boucle for envoie de manière asynchrone toutes les requêtes contenues dans &quot;headers&quot;
     * Comme nous avons besoin du résultat de toutes les requêtes avant de tracer le graphique et remplir le tableau,
     * l'utilisation du Promise.all est élémentaire
     */
    for (let i = 1; i &lt; headers.length; ++i) {
      promises.push(sendRequests(headers, i)); //Pousse dans la tableau des Promise, la promesse du résultat de la requête
    }
    Promise.all(promises)
      .then((results) =&gt; {
        traceGraph(adjustedUTC, results); //Trace the graph
        createTable(adjustedUTC, results); //Populate table
      }).catch(err =&gt; { //Catch failed fetch
        console.log(err);
      });
  }).catch(err =&gt; {
    console.log(err);
  });
</code></pre>
<h2 id="prepare-queries">Prepare queries</h2>
<p>The <code>prepareRequests</code> method is a short method that will be used to initialize an array (Array) containing all the information required to send requests to GeoMet. The first step will be to iterate through all the available times starting with <code>startDate</code> and adding<code>dif</code> to <code>endDate</code>. Subsequently, it suffices to initialize the URLs of each layer by omitting the <code>time =</code> parameter in order to have the basic requests for the <code>sendRequests</code> method.</p>
<pre><code class="language-javascript">function prepareRequests(headers, server) {
  const interval = headers[0];
  let startDate = headers[1];
  let dif = headers[2];
  let timesteps = [];
  timesteps.push(startDate.toISOString().replace('.000', '')); //Remove trailing zeroes for compatibility with time= parameter
  let increment = startDate;
  for (let i = 0; i &lt; dif; ++i) {
    increment.setHours(increment.getHours() + Number(interval)); //Set the hour according to the intervals supported
    timesteps.push(increment.toISOString().replace('.000', '')); //Add to timesteps array
  }
  let url02 = server +
    version + '&amp;request=' + request + '&amp;layers=' + layer02 + '&amp;crs=EPSG:4326&amp;bbox=' +
    minx + ',' + miny + ',' + maxx + ',' + maxy + '&amp;exceptions=xml&amp;width=10&amp;height=10&amp;INFO_FORMAT=' +
    info_format + '&amp;query_layers=' + layer02 + '&amp;x=1&amp;y=1';
  let url1 = server +
    version + '&amp;request=' + request + '&amp;layers=' + layer1 + '&amp;crs=EPSG:4326&amp;bbox=' +
    minx + ',' + miny + ',' + maxx + ',' + maxy + '&amp;exceptions=xml&amp;width=10&amp;height=10&amp;INFO_FORMAT=' +
    info_format + '&amp;query_layers=' + layer1 + '&amp;x=1&amp;y=1';
  let url25 = server +
    version + '&amp;request=' + request + '&amp;layers=' + layer25 + '&amp;crs=EPSG:4326&amp;bbox=' +
    minx + ',' + miny + ',' + maxx + ',' + maxy + '&amp;exceptions=xml&amp;width=10&amp;height=10&amp;INFO_FORMAT=' +
    info_format + '&amp;query_layers=' + layer25 + '&amp;x=1&amp;y=1';
  let url5 = server +
    version + '&amp;request=' + request + '&amp;layers=' + layer5 + '&amp;crs=EPSG:4326&amp;bbox=' +
    minx + ',' + miny + ',' + maxx + ',' + maxy + '&amp;exceptions=xml&amp;width=10&amp;height=10&amp;INFO_FORMAT=' +
    info_format + '&amp;query_layers=' + layer5 + '&amp;x=1&amp;y=1';
  let urlTemp = server +
    version + '&amp;request=' + request + '&amp;layers=' + layerTemp + '&amp;crs=EPSG:4326&amp;bbox=' +
    minx + ',' + miny + ',' + maxx + ',' + maxy + '&amp;exceptions=xml&amp;width=10&amp;height=10&amp;INFO_FORMAT=' +
    info_format + '&amp;query_layers=' + layerTemp + '&amp;x=1&amp;y=1';
  let urlWd = server +
    version + '&amp;request=' + request + '&amp;layers=' + layerWindDir + '&amp;crs=EPSG:4326&amp;bbox=' +
    minx + ',' + miny + ',' + maxx + ',' + maxy + '&amp;exceptions=xml&amp;width=10&amp;height=10&amp;INFO_FORMAT=' +
    info_format + '&amp;query_layers=' + layerWindDir + '&amp;x=1&amp;y=1';
  let urlWspd = server +
    version + '&amp;request=' + request + '&amp;layers=' + layerWindSp + '&amp;crs=EPSG:4326&amp;bbox=' +
    minx + ',' + miny + ',' + maxx + ',' + maxy + '&amp;exceptions=xml&amp;width=10&amp;height=10&amp;INFO_FORMAT=' +
    info_format + '&amp;query_layers=' + layerWindSp + '&amp;x=1&amp;y=1';
  let info = [];
  info.push(timesteps, url02, url1, url25, url5, urlTemp, urlWd, urlWspd);
  return info;
}
</code></pre>
<h2 id="adjust-hours">Adjust hours</h2>
<p>By default, valid times are <code>UTC-0</code>. Therefore, when the requests are sent and we try to display them, it is preferable to adjust the hours according to the local time zone in order to have a more representative idea of reality.
The <code>adjustUTC ()</code> method converts zulu dates to <code>ISO-8601</code> format and is then adjusted to the user's local time.</p>
<pre><code class="language-javascript">function adjustUTC(time) {
  let adjustedDate = [];
  let dateTime;
  for (let i = 0; i &lt; time.length; ++i) {
    dateTime = new Date(time[i]);
    adjustedDate.push(dateTime);
  }
  return adjustedDate;
}

</code></pre>
<h2 id="send-prepared-queries">Send prepared queries</h2>
<p>Remember that the for loop sends asynchronously all the requests contained in "headers". As we need the result of all queries before we plot the graph and populate the array, using the <code>Promise.all</code> is elementary in order to be able to display the result of our sent queries. For more information on using <code>Promises</code>, you can consult the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">official documentation</a>.</p>
<pre><code class="language-javascript">async function sendRequests(headers, nb) {
  let responses = [];
  let datesMod = [];
  let url = headers[nb].concat(&quot;&amp;time=&quot; + headers[0][0]);
  for (let k = 0; k &lt; headers[0].length; ++k) {
    datesMod.push(headers[0][k]);
  }
  for (let i = 0; i &lt; datesMod.length; ++i) {
    try {
      if (i != 0) {
        url = url.replace(/[^=]*$/.exec(url), datesMod[i]);
      }
      let response = await fetch(url);
      let data = await response.json();
      responses.push(data.features[0].properties.value);
    } catch (e) {
      console.log(e);
    }
  }
  return responses;
}
</code></pre>
<p>Now we have been able to write the necessary methods to query a layer by doing a <code>GetCapabilities</code>, perform a <code>GetFeatureInfo</code> to look up the information on our layers and finally collect the results by appending them to an array.</p>
<p>The asynchronous <code>GetCapabilities</code> method which serves as a foundation for our main algorithm returns an array containing three elements: The start date, the end date and the availability interval of our weather layer. These values ​​are essential to be able to send our requests to GeoMet.</p>
<p>The <code>prepareRequests</code> method calculates all the parameters of <code>time =</code> for the <code>GetFeatureInfo</code> requests to be made. Subsequently, the URLs are also created and the method returns an array containing the time periods and the URLs.
Finally, we can, using the <code>sendRequests</code> method, send all our requests to GeoMet and save the results.</p>
<p>Now that we have in the <code>results</code> variable, the result of all our queries, we can finally start to develop our <code>traceGraph</code> method to plot our graph using <code>Plotly.js</code>.</p>
<h2 id="interactive-web-graph-creation-with-plotlyjs">Interactive web graph creation with Plotly.js</h2>
<p>The <code>traceGraph</code> method uses the date array and the results array to plot a graph. The dates are in ISO-8601 format and will be concatenated in order to view the data in <code>YYYY-MM-DD HH:MM</code> format.
In our case, as the values of our layers used represent periods of 6 hours, an additional date is added 6 hours after the last available value of our weather layers in order to have a graph representative of reality.</p>
<pre><code class="language-javascript">function traceGraph(xaxis, yaxis) {
  let date = [];
  let tempRounded = [];
  let windKm = [];
  let lastDate = new Date(xaxis[xaxis.length-1]);
  lastDate.setHours(lastDate.getHours() + 6);
  lastDate = lastDate.toLocaleString('fr-CA');
  lastDate = lastDate.substring(0, lastDate.indexOf('m'));
  lastDate = lastDate.replace(' h ', 'h');

  for (let i = 0; i &lt; xaxis.length; ++i) {
    date[i] = xaxis[i].toLocaleString('fr-CA');
    date[i] = date[i].substring(0, date[i].indexOf('m'));
    date[i] = date[i].replace(' h ', 'h');
  }
  date.push(lastDate);
  for (let j = 0; j &lt; yaxis[4].length; ++j) {
    tempRounded[j] = Number(Math.round(yaxis[4][j]));
  }
  for (let k = 0; k &lt; yaxis[6].length; ++k) {
    if (!isNaN(Math.round(yaxis[6][k]))) {
      windKm[k] = Number(Math.round(yaxis[6][k] * 3.6));
    }
  }
  for (let l = 0; l &lt; yaxis.length; ++l) {
    yaxis[l].push(0);
  }
  var trace1 = {
    x: date,
    y: yaxis[0],
    mode: 'lines+markers',
    name: '≥ 0.5mm',
    line: {
      color: 'rgb(144, 224, 239)',
      width: 3,
      shape: 'hv'
    },
    fill: 'tozeroy',
  };
  var trace2 = {
    x: date,
    y: yaxis[1],
    mode: 'lines+markers',
    name: '≥ 1.0mm',
    line: {
      color: 'rgb(72, 202, 228)',
      width: 3,
      shape: 'hv'
    },
    fill: 'tozeroy',
  }
  var trace3 = {
    x: date,
    y: yaxis[2],
    mode: 'lines+markers',
    name: '≥ 2.5mm',
    line: {
      color: 'rgb(0, 150, 199)',
      width: 3,
      shape: 'hv'
    },
    fill: 'tozeroy',
  }
  var trace4 = {
    x: date,
    y: yaxis[3],
    mode: 'lines+markers',
    name: '≥ 5.0mm',
    line: {
      color: 'rgb(2, 62, 138)',
      width: 3,
      shape: 'hv'
    },
    fill: 'tozeroy',
  }
  var layout = {
    title: 'Probabilités de précipitations',
    automargin: true,
    showlegend: true,
    showlegend: true,
    legend: {
      &quot;orientation&quot;: &quot;h&quot;
    },
    xaxis: {
      showticklabels: true,
      tickangle: 0,
      nticks: 6,
      tickfont: {
        family: 'Old Standard TT, serif',
        size: 12,
        color: 'black'
      },
    },
    yaxis: {
      title: 'Probabilités (%)',
      range: [0, 100]
    }
  };

var data = [trace1, trace2, trace3, trace4 /*trace5, trace6*/];
  Plotly.newPlot('reps0', data, layout);
}
</code></pre>
<p>Here's an example of the graph</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="" title="Création de graphique avec GeoMet" src="https://codepen.io/opdelta/embed/YzVEEJg?default-tab=html%2Cresult" frameborder="no" loading="lazy" allowtransparency="true" allowfullscreen="true">
  See then Pen <a href="https://codepen.io/opdelta/pen/YzVEEJg">
  </a> by opdelta (<a href="https://codepen.io/opdelta">@opdelta</a>)
  on <a href="https://codepen.io">CodePen</a>.
</iframe>

<h2 id="view-data-in-a-table">View data in a table</h2>
<p>For the creation of the table, we can now manipulate the results of our queries to display them in the HTML table of the document.</p>
<p>We want to create a method that will take as parameters, the table of dates and the table of results. In our cases, the <code>data</code> array contains the following elements:</p>
<ul>
<li>[0] = REPS.DIAG.6_PRMM.ERGE0.5 data table</li>
<li>[1] = REPS.DIAG.6_PRMM.ERGE1 data table</li>
<li>[2] = REPS.DIAG.6_PRMM.ERGE2.5 data table</li>
<li>[3] = REPS.DIAG.6_PRMM.ERGE5 data table</li>
<li>[4] = REPS.ETA_TT data table</li>
<li>[5] = REPS.ETA_WD data table</li>
<li>[6] = REPS.ETA_WSPD data table</li>
</ul>
<pre><code class="language-javascript">function createTable(date, data) {
  for (let z = 0; z &lt; data.length; ++z) {
    data[z].pop();
  }
  let table = document.querySelector(&quot;#table-probs&quot;);
  let row;
  for (let k = 0; k &lt; date.length; ++k) {
    date[k] = date[k].toLocaleString('fr-CA');
    date[k] = date[k].substring(0, date[k].indexOf('m'));
    date[k] = date[k].replace(' h ', 'h');
  }
  for (let i = 0; i &lt; date.length; ++i) {
    row = table.insertRow(-1);
    let cell1 = row.insertCell(0);
    let cell2 = row.insertCell(1);
    let cell3 = row.insertCell(-1);
    let cell4 = row.insertCell(-1);
    let cell5 = row.insertCell(-1);
    let cell6 = row.insertCell(-1);
    let cell7 = row.insertCell(-1);
    if (!isNaN(Math.round(data[4][i]))) {
      cell6.innerHTML = Math.round(data[4][i]) + &quot; °C&quot;;
    } else {
      cell6.setAttribute(&quot;id&quot;, &quot;nan&quot;);
    }
    if (!isNaN(Math.round(data[5][i])) &amp;&amp; !isNaN(Math.round(data[6][i]))) {
      cell7.innerHTML = Math.round(data[6][i] * 3.6) + &quot; km/h &quot; + degToCompass(data[5][i]);
    } else {
      cell7.setAttribute(&quot;id&quot;, &quot;nan&quot;);
    }
    cell1.innerHTML = date[i];
    cell2.innerHTML = data[0][i] + &quot; %&quot;;
    cell3.innerHTML = data[1][i] + &quot; %&quot;;
    cell4.innerHTML = data[2][i] + &quot; %&quot;;
    cell5.innerHTML = data[3][i] + &quot; %&quot;;
  }
}
</code></pre>
<p>When using the <code>RDPS.ETA_WD</code> layer to get the wind direction, the returned value is an angle. We can convert the angle to cardinal with the following method:</p>
<pre><code class="language-javascript">function degToCompass(num) {
  let val = Number((num / 45));
  let arr = [&quot;N&quot;, &quot;NE&quot;, &quot;E&quot;, &quot;SE&quot;, &quot;S&quot;, &quot;SO&quot;, &quot;O&quot;, &quot;NO&quot;];
  if (Math.round((val % 8)) == 8) {
    return &quot;Variables&quot;;
  }
  return arr[Math.round((val % 8))];
}
</code></pre>
<p>Here is an example of the representation of the graph and the table on the same page.</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="" src="https://codepen.io/opdelta/embed/bGWaQGO?default-tab=html%2Cresult" frameborder="no" loading="lazy" allowtransparency="true" allowfullscreen="true">
  See the Pen <a href="https://codepen.io/opdelta/pen/bGWaQGO">
  </a> by opdelta (<a href="https://codepen.io/opdelta">@opdelta</a>)
  on <a href="https://codepen.io">CodePen</a>.
</iframe>

<h2 id="add-a-heatmap-to-a-table">Add a heatmap to a table</h2>
<p>Now we are able to query a layer by doing a <code>getCapabilities</code>, manipulate the time periods available for a particular layer, send requests to GeoMet in order to obtain the weather information necessary to display a graph and a table of this data. The table being now finished, we can add a little CSS in order to have a "heat map" according to the forecasts of each period of time.</p>
<p>Before adding our CSS, we can initialize a new global constant:</p>
<pre><code class="language-javascript">const colorArray = [&quot;low0&quot;,&quot;low1&quot;,&quot;low2&quot;,&quot;low3&quot;,&quot;medium1&quot;,&quot;medium2&quot;,&quot;medium3&quot;,&quot;high1&quot;,&quot;high2&quot;,&quot;high3&quot;,&quot;high4&quot;];
</code></pre>
<p>the variable <code>colorArray</code> has 11 color variants defined in our CSS document like this:</p>
<pre><code class="language-css">.low1 {
   background-color: #d8f3dc;
   color: black;
 }

 .low2 {
   background-color: #B7E4C7;
   color: black;
 }

 .low3 {
   background-color: #95D5B2;
   color: black;
 }

 .medium1 {
   background-color: #74C69D;
   color: black;
 }

 .medium2 {
   background-color: #52B788;
   color: black;
 }

 .medium3 {
   background-color: #40916C;
   color: white;
 }

.high1 {
   background-color: #2D6A4F;
   color: white;
 }

.high2 {
   background-color: #245741;
   color: white;
 }

 .high3 {
   background-color: #1B4332;
   color: white;
 }
.high4 {
  background-color: #081C15;
  color: white;
}
</code></pre>
<p>Depending on the forecast value, we want the representative cell in the table to turn darker. In our <code>createTable()</code> method, let's add this <code>for</code> loop at the very end just below the line <code>cell5.innerHTML = data [3] [i] + "%";</code>:</p>
<pre><code class="language-javascript">for (let j = 0; j &lt; 4; ++j) {
      switch(j) {
        case 0:
          let val = data[0][i] / 10;
          cell2.classList.add(colorArray[Math.round(val % 11)]);
          break;
        case 1:
          let val1 = data[1][i] / 10;
          cell3.classList.add(colorArray[Math.round(val1 % 11)]);
          break;
        case 2:
          let val2 = data[2][i] / 10;
          cell4.classList.add(colorArray[Math.round(val2 % 11)]);
          break;
        case 3:
          let val3 = data[3][i] / 10;
          cell5.classList.add(colorArray[Math.round(val3 % 11)]);
          break;
      }
    }
</code></pre>
<p>Here's an example of the final product</p>
<iframe height="300" style="width: 100%;" scrolling="no" title="" src="https://codepen.io/opdelta/embed/oNWpQWp?default-tab=html%2Cresult" frameborder="no" loading="lazy" allowtransparency="true" allowfullscreen="true">
  See the Pen <a href="https://codepen.io/opdelta/pen/oNWpQWp">
  </a> by opdelta (<a href="https://codepen.io/opdelta">@opdelta</a>)
  on <a href="https://codepen.io">CodePen</a>.
</iframe></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                    <br>
                    Effectuez une recherche dans la documentation en indiquant les termes désirés ci-après.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

        <!-- Matomo -->
        <script>
            var _paq = window._paq = window._paq || [];
            /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
            _paq.push(['trackPageView']);
            _paq.push(['enableLinkTracking']);
            (function() {
            var u="https://msc-analytics.ca/piwik/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
            _paq.push(['setSiteId', '13']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
            })();
        </script>
        <!-- End Matomo Code -->
    </body>
</html>
